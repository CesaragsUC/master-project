name: Code Quality and Deploy
on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'
  pull_request:
    types: [opened, synchronize, reopened,edited]
    
  workflow_dispatch:
    inputs:
      version:
        description: "New version for all projects"
        required: true 
        type: string

jobs:

  build:
    name: Executing build
    runs-on: ubuntu-latest
    steps:
      
        - name: Fetching project code ⏳
          uses: actions/checkout@v4
        - name: Setup dotnet
          uses: actions/setup-dotnet@v4
          with:
              dotnet-version: 8.0.300
        - name: Executing dotnet build
          working-directory: .
          run: dotnet build CasoftStore.sln

  tests:
        needs: build
        uses: CesaragsUC/master-project/.github/workflows/test.yml@main
        secrets: inherit

  release:
        name: Creating release
        runs-on: ubuntu-latest
       # needs: tests
        permissions:
            security-events: write  # Permissão para publicar na aba de segurança
        outputs:
            clean_version: ${{ steps.clean_version.outputs.clean_version }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
                fetch-tags: true


            - name: Set project versions
              id: update
              uses: vers-one/dotnet-project-version-updater@v1.7
              with:
                file: "src/Api.Catalogo"
                version: ${{ github.event.inputs.version }}

            - run: |
                git config user.name "CesaragsUC"
                git config user.email "cesar_ags@users.noreply.github.com"
                git add .
                git commit -m "Update project versions to ${{ steps.release.outputs.newVersion }}"
                git push
