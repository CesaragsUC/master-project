name: Code Quality and Deploy
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]


jobs:

  build:
    name: Executing build
    runs-on: ubuntu-latest
    steps:
        - name: Fetching project code ⏳
          uses: actions/checkout@v4
        - name: Setup dotnet
          uses: actions/setup-dotnet@v4
          with:
              dotnet-version: 8.0.300
        - name: Executing dotnet build
          working-directory: .
          run: dotnet build CasoftStore.sln

  tests:
        needs: build
        uses: CesaragsUC/master-project/.github/workflows/test.yml@main
        secrets: inherit

  release:
        name: Creating release
        runs-on: ubuntu-latest
        needs: tests
        permissions:
            security-events: write  # Permissão para publicar na aba de segurança
        steps:
            - name: Fetching project code ⏳
              uses: actions/checkout@v4

            - name: Analysing Dockerfile Catalog.Api
              with:
                 dockerfile: ./src/Catalog.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 # serve para analisar o Dockerfile em busca de erros e boas práticas

            - name: Login into Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push Docker image for Catalog.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Catalog.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-catalog:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-catalog:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Catalog.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-catalog:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif                  
#--------------------------------------------------------------------------------------
  
            - name: Analysing Dockerfile Product.Api
              with:
                 dockerfile: ./src/Product.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Product.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Product.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-product:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-product:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Product.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-product:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'         
                
            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Order.Api
              with:
                 dockerfile: ./src/Order.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Order.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Order.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-order:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-order:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Order.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-order:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'         

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif                  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Discount.Api
              with:
                 dockerfile: ./src/Discount.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Discount.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Discount.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-discount:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-discount:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Discount.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-discount:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif                  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Payment.Api
              with:
                 dockerfile: ./src/Payment.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Payment.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Payment.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-billing:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-billing:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Payment.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-billing:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'                


            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Basket.Api
              with:
                 dockerfile: ./src/Basket.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Basket.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Basket.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-basket:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-basket:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Basket.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-basket:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'                 

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif                  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Auth.Api
              with:
                 dockerfile: ./src/Auth.Api/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Auth.Api
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Auth.Api/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-auth:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-auth:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Auth.Api
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-auth:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif                  
#--------------------------------------------------------------------------------------
            - name: Analysing Dockerfile Api.Gateway
              with:
                 dockerfile: ./src/Api.Gateway/Dockerfile
              uses: hadolint/hadolint-action@v3.1.0 

            - name: Build and push Docker image for Api.Gateway
              uses: docker/build-push-action@v3
              with:
                context: ./src
                file: ./src/Api.Gateway/Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-api-gateway:latest
                    ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-api-gateway:v${{ github.run_number }}

            - name: Run Trivy vulnerability scanner on Docker image for Api.Gateway
              uses: aquasecurity/trivy-action@0.28.0
              with:
                image-ref: ${{ secrets.DOCKER_NAMESPACE }}/casoft-store-api-gateway:v${{ github.run_number }}
                format: sarif
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: trivy-results.sarif
#--------------------------------------------------------------------------------------                  
  
  # deploy:
  #       needs: release
  #       uses: CesaragsUC/master-project/.github/workflows/deploy.yml@main
  #       secrets: inherit