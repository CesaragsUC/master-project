name: Code Quality and Deploy
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened,edited]
    
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "${{ github.ref }}-${{ github.workflow }}"
  cancel-in-progress: true
  
jobs:

  build:
    name: Executing build
    runs-on: ubuntu-latest
    steps:
        - name: Fetching project code ⏳
          uses: actions/checkout@v4
        - name: Setup dotnet
          uses: actions/setup-dotnet@v4
          with:
              dotnet-version: 8.0.300
        - name: Executing dotnet build
          working-directory: .
          run: dotnet build CasoftStore.sln

  # tests:
  #       needs: build
  #       uses: CesaragsUC/master-project/.github/workflows/test.yml@main
  #       secrets: inherit

  release:
        name: Creating release
        runs-on: ubuntu-latest
       # needs: tests
        permissions:
            contents: write
            security-events: write  # Permissão para publicar na aba de segurança
        outputs:
            clean_version: ${{ steps.clean_version.outputs.clean_version }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
                fetch-tags: true

            - name: Checkout code
              uses: actions/checkout@v3
              with:
                fetch-depth: 0
                fetch-tags: true

            - name: calculate version
              id: calculate-version
              uses: bitshifted/git-auto-semver@v2
              with:
                main_branch: master
                create_tag: true
                tag_prefix: 'tags'              

            - name: Use version
              run: 'echo "Calculated version: ${{ steps.calculate-version.outputs.version-string }}"'

            - name: New tag version
              run: |
                echo "tag:  ${{ env.VERSION }}"
